<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Item Database</title>
<style>
:root{
  --bg0:#070A12;
  --bg1:#0B1020;
  --border:rgba(255,255,255,.08);
  --text:#E7EAF2;
  --muted:#A8B1C2;
  --muted2:#7F8AA1;
  --accent:#62B0FF;
  --accent2:#8B5CFF;
  --shadow: 0 12px 40px rgba(0,0,0,.45);
  --shadow2: 0 10px 30px rgba(0,0,0,.35);
  --radius: 18px;
}

*{ box-sizing:border-box; }
html,body{ height:100%; }

body{
  margin:0;
  font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  color: var(--text);
  background:
    radial-gradient(1200px 800px at 20% 10%, rgba(98,176,255,.16), transparent 60%),
    radial-gradient(1000px 700px at 85% 20%, rgba(139,92,255,.12), transparent 55%),
    linear-gradient(180deg, var(--bg0), var(--bg1));
}

header{
  position: sticky;
  top: 0;
  z-index: 10;
  padding: 16px 22px;
  border-bottom: 1px solid var(--border);
  background: linear-gradient(180deg, rgba(16,26,49,.92), rgba(11,16,32,.82));
  backdrop-filter: blur(10px);
}

.header-inner{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap: 14px;
}

.brand{
  display:flex;
  align-items:center;
  gap: 10px;
  font-weight: 700;
  letter-spacing: .2px;
  font-size: 18px;
}

.badge{
  font-size: 12px;
  padding: 4px 10px;
  border-radius: 999px;
  color: rgba(231,234,242,.9);
  border: 1px solid var(--border);
  background: rgba(255,255,255,.04);
}

main{
  display:grid;
  grid-template-columns: 360px 1fr;
  min-height: calc(100vh - 60px);
}

aside{
  border-right: 1px solid var(--border);
  background: linear-gradient(180deg, rgba(16,26,49,.55), rgba(11,16,32,.4));
  padding: 14px;
  overflow: auto;
}

.panel{
  border: 1px solid var(--border);
  background: linear-gradient(180deg, rgba(14,20,38,.75), rgba(11,16,32,.55));
  border-radius: var(--radius);
  box-shadow: var(--shadow2);
  overflow: hidden;
}

.sidebar-top{
  padding: 14px;
  border-bottom: 1px solid var(--border);
}

.search{
  display:flex;
  align-items:center;
  gap: 10px;
  padding: 10px 12px;
  border-radius: 14px;
  border: 1px solid var(--border);
  background: rgba(255,255,255,.03);
}

.search input{
  width:100%;
  border:none;
  outline:none;
  background: transparent;
  color: var(--text);
  font-size: 14px;
}

.search input::placeholder{ color: var(--muted2); }

.hint{
  margin-top: 10px;
  color: var(--muted2);
  font-size: 12px;
  line-height: 1.35;
}

.sidebar-scroll{
  padding: 10px;
}

.group{ margin: 6px 0; }

.group-title{
  width: 100%;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap: 10px;
  padding: 10px 12px;
  border-radius: 14px;
  cursor: pointer;
  user-select:none;
  color: rgba(231,234,242,.95);
  background: rgba(255,255,255,.02);
  border: 1px solid rgba(255,255,255,.06);
  transition: background .15s ease, border-color .15s ease;
}
.group-title:hover{
  background: rgba(98,176,255,.08);
  border-color: rgba(98,176,255,.18);
}

.chev{
  width: 28px;
  height: 28px;
  display:grid;
  place-items:center;
  border-radius: 10px;
  border: 1px solid rgba(255,255,255,.06);
  background: rgba(255,255,255,.03);
}
.group.open .chev{
  border-color: rgba(98,176,255,.25);
  background: rgba(98,176,255,.10);
}

.group-content{
  display:none;
  margin: 10px 0 14px 10px;
  padding-left: 10px;
  border-left: 1px solid rgba(255,255,255,.08);
}
.group.open .group-content{ display:block; }

.subgroup{ margin: 8px 0; }

.subgroup-title{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap: 10px;
  padding: 8px 10px;
  border-radius: 12px;
  cursor: pointer;
  user-select:none;
  color: rgba(231,234,242,.9);
  background: rgba(255,255,255,.02);
  border: 1px solid rgba(255,255,255,.06);
}
.subgroup-title:hover{
  background: rgba(255,255,255,.05);
  border-color: rgba(255,255,255,.10);
}

.subgroup .item-list{
  display:none;
  padding: 8px 0 0 10px;
}
.subgroup.open .item-list{ display:block; }

.item{
  padding: 7px 10px;
  border-radius: 12px;
  cursor:pointer;
  color: var(--muted);
  border: 1px solid transparent;
  transition: background .15s ease, color .15s ease, border-color .15s ease;
}
.item:hover{
  background: rgba(255,255,255,.05);
  color: rgba(231,234,242,.95);
  border-color: rgba(255,255,255,.06);
}
.item.active{
  background: linear-gradient(180deg, rgba(98,176,255,.16), rgba(98,176,255,.08));
  color: #fff;
  border-color: rgba(98,176,255,.28);
}

section{
  padding: 24px;
  overflow: auto;
}

.card{
  max-width: 1100px;
  border: 1px solid var(--border);
  border-radius: 22px;
  box-shadow: var(--shadow);
  background: linear-gradient(180deg, rgba(16,26,49,.75), rgba(11,16,32,.58));
  overflow: hidden;
}

.card-header{
  display:flex;
  gap: 18px;
  padding: 18px 18px 14px 18px;
  align-items:center;
  border-bottom: 1px solid var(--border);
  background:
    radial-gradient(900px 220px at 20% 0%, rgba(98,176,255,.18), transparent 60%),
    radial-gradient(700px 240px at 90% 30%, rgba(139,92,255,.12), transparent 55%),
    linear-gradient(180deg, rgba(14,20,38,.55), rgba(11,16,32,.35));
}

.thumb{
  width: 92px;
  height: 92px;
  border-radius: 20px;
  overflow:hidden;
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.04);
  display:grid;
  place-items:center;
  flex: 0 0 auto;
  position: relative;
}

.thumb img{
  width:100%;
  height:100%;
  object-fit: cover;
  opacity: 0;
  transition: opacity .25s ease;
}

.thumb .loading{
  position:absolute;
  inset:0;
  display:grid;
  place-items:center;
  color: rgba(231,234,242,.72);
  font-size: 12px;
}

.thumb .noimg{
  color: rgba(231,234,242,.65);
  font-size: 12px;
}

.title-wrap{ min-width: 0; }

.h1{
  margin: 0;
  font-size: 22px;
  font-weight: 750;
  letter-spacing: .2px;
}

.subtitle{
  margin-top: 6px;
  color: var(--muted);
  font-size: 13px;
}

.pills{
  margin-top: 10px;
  display:flex;
  flex-wrap: wrap;
  gap: 8px;
}

.pill{
  font-size: 12px;
  padding: 5px 10px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.04);
  color: rgba(231,234,242,.92);
}

.card-body{ padding: 18px; }

.grid{
  display:grid;
  grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
  gap: 12px;
}

.field{
  border: 1px solid rgba(255,255,255,.08);
  border-radius: 16px;
  padding: 12px 12px 10px 12px;
  background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015));
}

.key{
  font-size: 12px;
  letter-spacing: .2px;
  color: var(--muted2);
  margin-bottom: 8px;
  text-transform: uppercase;
}

.value{
  font-size: 13px;
  color: rgba(231,234,242,.96);
  word-break: break-word;
}

.kv{
  display:flex;
  flex-direction:column;
  gap: 8px;
}

.kv-row{
  display:grid;
  grid-template-columns: 1fr auto;
  gap: 10px;
  align-items:center;
  padding: 10px 10px;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,.08);
  background: rgba(0,0,0,.14);
}

.kv-key{
  color: rgba(168,177,194,.95);
  font-size: 12px;
  letter-spacing: .2px;
  text-transform: uppercase;
}

.kv-val{
  color: rgba(231,234,242,.97);
  font-size: 13px;
  font-variant-numeric: tabular-nums;
}

.nested{
  padding: 10px;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,.08);
  background: rgba(0,0,0,.14);
}

.nested pre{
  margin:0;
  padding: 10px 10px;
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,.08);
  background: rgba(0,0,0,.16);
  overflow:auto;
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
  font-size: 12px;
  line-height: 1.35;
  color: rgba(231,234,242,.92);
}

.placeholder{
  color: var(--muted);
  border: 1px dashed rgba(255,255,255,.16);
  border-radius: 18px;
  padding: 18px;
  max-width: 1100px;
  background: rgba(255,255,255,.02);
}

@media (max-width: 980px){
  main{ grid-template-columns: 1fr; }
  aside{ border-right: none; border-bottom: 1px solid var(--border); }
}
</style>
</head>
<body>
<header>
  <div class="header-inner">
    <div class="brand">
      Item Database
      <span class="badge" id="counts">Loading…</span>
    </div>
    <div class="badge">GitHub Pages-ready</div>
  </div>
</header>

<main>
  <aside>
    <div class="panel">
      <div class="sidebar-top">
        <div class="search">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="currentColor" stroke-width="2" opacity=".9"/>
            <path d="M16.5 16.5 21 21" stroke="currentColor" stroke-width="2" stroke-linecap="round" opacity=".9"/>
          </svg>
          <input id="search" type="text" placeholder="Search items (name, category, subgroup)..." />
        </div>
        <div class="hint">Tip: search auto-expands and jumps to the first match.</div>
      </div>
      <div class="sidebar-scroll" id="sidebar"></div>
    </div>
  </aside>

  <section id="content">
    <div class="placeholder">Select an item to view its details.</div>
  </section>
</main>

<script>
function titleCase(s){
  return String(s).replace(/_/g,' ').replace(/\b\w/g, m => m.toUpperCase());
}
function normalizeCategory(path){
  const parts = String(path).split('/');
  const group = (parts[0] || 'misc').toLowerCase();
  const sub = (parts[1] || '').replace(/\.lua$/i,'');
  return { group, sub: sub || 'misc' };
}
function isPlainObject(v){
  return v && typeof v === 'object' && !Array.isArray(v);
}
function formatScalar(v){
  if (v === null) return '∞';
  if (typeof v === 'boolean') return v ? 'true' : 'false';
  return String(v);
}
function extractAssetId(imageField){
  if (imageField === null || imageField === undefined) return null;

  if (typeof imageField === 'number' && Number.isFinite(imageField)) {
    return String(Math.trunc(imageField));
  }
  const s = String(imageField);

  const m1 = s.match(/rbxassetid:\/\/(\d+)/i);
  if (m1) return m1[1];

  const m2 = s.match(/[?&]assetId=(\d+)/i);
  if (m2) return m2[1];

  const m3 = s.match(/[?&]aid=(\d+)/i);
  if (m3) return m3[1];

  const m4 = s.match(/\b(\d{6,})\b/);
  if (m4) return m4[1];

  return null;
}

// Roblox thumbnails API (assets)
function thumbApiUrl(assetId, size){
  const params = new URLSearchParams({
    assetIds: String(assetId),
    returnPolicy: "PlaceHolder",
    size: size,
    format: "Png",
    isCircular: "false"
  });
  return `https://thumbnails.roblox.com/v1/assets?${params.toString()}`;
}

const thumbCache = new Map(); // assetId -> Promise<string|null>

async function getThumbnailUrl(assetId, preferredSize){
  if (!assetId) return null;
  if (thumbCache.has(assetId)) return thumbCache.get(assetId);

  const p = (async () => {
    // Prefer a large square. If Roblox rejects the size, fallback to smaller common sizes.
    const sizesToTry = [preferredSize, "420x420", "150x150", "110x110", "48x48", "30x30"]
      .filter((v, i, a) => v && a.indexOf(v) === i);

    for (const size of sizesToTry){
      try{
        const res = await fetch(thumbApiUrl(assetId, size), { method: "GET" });
        if (!res.ok) continue;
        const js = await res.json();
        const entry = js && js.data && js.data[0];
        if (entry && entry.imageUrl){
          // Use imageUrl regardless of state, since returnPolicy=PlaceHolder gives a usable URL even when pending.
          return entry.imageUrl;
        }
      } catch (e){
        // continue trying smaller sizes
      }
    }
    return null;
  })();

  thumbCache.set(assetId, p);
  return p;
}

function renderValueNode(value, keyHint){
  // Scalar
  if (value === null || typeof value !== 'object') {
    const span = document.createElement('span');
    span.textContent = formatScalar(value);
    return span;
  }

  // Array -> compact dump
  if (Array.isArray(value)) {
    const wrap = document.createElement('div');
    wrap.className = 'nested';
    const pre = document.createElement('pre');
    pre.textContent = JSON.stringify(value, null, 2);
    wrap.appendChild(pre);
    return wrap;
  }

  // damages -> clean table (null => ∞)
  if (keyHint && String(keyHint).toLowerCase() === 'damages' && isPlainObject(value)) {
    const kv = document.createElement('div');
    kv.className = 'kv';
    const keys = Object.keys(value).sort((a,b)=>a.localeCompare(b));
    for (const k of keys) {
      const row = document.createElement('div');
      row.className = 'kv-row';
      const kk = document.createElement('div');
      kk.className = 'kv-key';
      kk.textContent = titleCase(k);
      const vv = document.createElement('div');
      vv.className = 'kv-val';
      vv.textContent = formatScalar(value[k]);
      row.appendChild(kk);
      row.appendChild(vv);
      kv.appendChild(row);
    }
    return kv;
  }

  // Generic object -> pretty key/value list, fallback to neat JSON for deep nesting
  const keys = Object.keys(value).sort((a,b)=>a.localeCompare(b));
  const hasDeep = keys.some(k => isPlainObject(value[k]) || Array.isArray(value[k]));
  const tooLarge = keys.length > 14;

  if (hasDeep && tooLarge){
    const wrap = document.createElement('div');
    wrap.className = 'nested';
    const pre = document.createElement('pre');
    const replacer = (k,v)=> (v === null ? '∞' : v);
    pre.textContent = JSON.stringify(value, replacer, 2);
    wrap.appendChild(pre);
    return wrap;
  }

  const kv = document.createElement('div');
  kv.className = 'kv';
  for (const k of keys){
    const row = document.createElement('div');
    row.className = 'kv-row';
    const kk = document.createElement('div');
    kk.className = 'kv-key';
    kk.textContent = titleCase(k);
    const vv = document.createElement('div');
    vv.className = 'kv-val';
    if (value[k] === null || typeof value[k] !== 'object'){
      vv.textContent = formatScalar(value[k]);
    } else {
      // shallow nested
      const replacer = (k2,v2)=> (v2 === null ? '∞' : v2);
      vv.textContent = JSON.stringify(value[k], replacer, 0);
    }
    row.appendChild(kk);
    row.appendChild(vv);
    kv.appendChild(row);
  }
  return kv;
}

async function load(){
  const res = await fetch('./items.json');
  const data = await res.json();

  // group -> subgroup -> items
  const groups = {};
  let totalGroups = 0, totalItems = 0;

  for (const [path, items] of Object.entries(data)){
    const { group, sub } = normalizeCategory(path);
    groups[group] ??= {};
    groups[group][sub] ??= {};
    Object.assign(groups[group][sub], items);
  }

  totalGroups = Object.keys(groups).length;
  for (const g of Object.values(groups)){
    for (const sub of Object.values(g)){
      totalItems += Object.keys(sub).length;
    }
  }
  document.getElementById('counts').textContent = `${totalGroups} categories • ${totalItems} items`;

  const sidebar = document.getElementById('sidebar');
  const content = document.getElementById('content');
  const search = document.getElementById('search');

  const groupMeta = new Map(); // groupName -> { groupEl, subMap }
  const itemMeta = []; // { itemEl, subgroupEl, groupEl, groupName, subName, itemNameLower, itemData }

  function renderCard(itemName, itemData, meta){
    content.innerHTML = '';

    const card = document.createElement('div');
    card.className = 'card';

    const header = document.createElement('div');
    header.className = 'card-header';

    const thumb = document.createElement('div');
    thumb.className = 'thumb';

    const loading = document.createElement('div');
    loading.className = 'loading';
    loading.textContent = 'Loading…';
    thumb.appendChild(loading);

    const img = document.createElement('img');
    img.alt = itemName;

    const assetId = extractAssetId(itemData.image);

    // Load thumbnail via Roblox thumbnails API -> imageUrl
    (async () => {
      if (!assetId){
        loading.remove();
        const no = document.createElement('div');
        no.className = 'noimg';
        no.textContent = 'No image';
        thumb.appendChild(no);
        return;
      }

      const url = await getThumbnailUrl(assetId, "420x420");
      if (!url){
        loading.remove();
        const no = document.createElement('div');
        no.className = 'noimg';
        no.textContent = 'No image';
        thumb.appendChild(no);
        return;
      }

      img.onload = () => {
        img.style.opacity = '1';
        loading.remove();
      };
      img.onerror = () => {
        loading.remove();
        const no = document.createElement('div');
        no.className = 'noimg';
        no.textContent = 'No image';
        thumb.appendChild(no);
      };
      img.src = url;
      thumb.appendChild(img);
    })();

    const tw = document.createElement('div');
    tw.className = 'title-wrap';

    const h = document.createElement('h2');
    h.className = 'h1';
    h.textContent = itemName;

    const sub = document.createElement('div');
    sub.className = 'subtitle';
    const pieces = [];
    if (meta?.group) pieces.push(titleCase(meta.group));
    if (meta?.sub && meta.sub !== 'misc') pieces.push(titleCase(meta.sub));
    sub.textContent = pieces.join(' • ');

    const pills = document.createElement('div');
    pills.className = 'pills';

    const rarity = itemData.Rarity || itemData.rarity;
    const type = itemData.itemType || itemData.type;

    if (type){
      const p = document.createElement('span');
      p.className = 'pill';
      p.textContent = String(type);
      pills.appendChild(p);
    }
    if (rarity){
      const p = document.createElement('span');
      p.className = 'pill';
      p.textContent = String(rarity);
      pills.appendChild(p);
    }
    if (itemData.level !== undefined){
      const p = document.createElement('span');
      p.className = 'pill';
      p.textContent = `Level ${itemData.level}`;
      pills.appendChild(p);
    }
    if (itemData.coinValue !== undefined){
      const p = document.createElement('span');
      p.className = 'pill';
      p.textContent = `Value ${itemData.coinValue}`;
      pills.appendChild(p);
    }

    tw.appendChild(h);
    tw.appendChild(sub);
    if (pills.childElementCount) tw.appendChild(pills);

    header.appendChild(thumb);
    header.appendChild(tw);

    const body = document.createElement('div');
    body.className = 'card-body';

    const grid = document.createElement('div');
    grid.className = 'grid';

    const preferred = ['damages','recipe','toolType','useType','speed','protection','locus','load','maxLoad','craftLevel','craftQuantity','admin','noDrop','rebirthPersist','description'];
    const keys = Object.keys(itemData).filter(k => k !== 'image');
    keys.sort((a,b)=>{
      const ai = preferred.indexOf(a);
      const bi = preferred.indexOf(b);
      if (ai === -1 && bi === -1) return a.localeCompare(b);
      if (ai === -1) return 1;
      if (bi === -1) return -1;
      return ai - bi;
    });

    for (const k of keys){
      const v = itemData[k];
      const f = document.createElement('div');
      f.className = 'field';

      const kk = document.createElement('div');
      kk.className = 'key';
      kk.textContent = k;

      const vv = document.createElement('div');
      vv.className = 'value';
      vv.appendChild(renderValueNode(v, k));

      f.appendChild(kk);
      f.appendChild(vv);
      grid.appendChild(f);
    }

    body.appendChild(grid);
    card.appendChild(header);
    card.appendChild(body);
    content.appendChild(card);
  }

  function buildUI(){
    sidebar.innerHTML = '';
    groupMeta.clear();
    itemMeta.length = 0;

    const groupOrder = Object.keys(groups).sort((a,b)=>a.localeCompare(b));
    for (const groupName of groupOrder){
      const groupEl = document.createElement('div');
      groupEl.className = 'group';

      const title = document.createElement('div');
      title.className = 'group-title';
      const left = document.createElement('div');
      left.textContent = titleCase(groupName);
      const chev = document.createElement('div');
      chev.className = 'chev';
      chev.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none"><path d="M9 6l6 6-6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" opacity=".9"/></svg>';
      title.appendChild(left);
      title.appendChild(chev);

      const groupContent = document.createElement('div');
      groupContent.className = 'group-content';

      title.onclick = () => groupEl.classList.toggle('open');

      const subMap = new Map();

      const subOrder = Object.keys(groups[groupName]).sort((a,b)=>a.localeCompare(b));
      for (const subName of subOrder){
        const subgroupEl = document.createElement('div');
        subgroupEl.className = 'subgroup';

        const subTitle = document.createElement('div');
        subTitle.className = 'subgroup-title';
        const subLeft = document.createElement('div');
        subLeft.textContent = (subName === 'misc') ? 'Misc' : titleCase(subName);
        const subChev = document.createElement('div');
        subChev.className = 'chev';
        subChev.style.width = '26px';
        subChev.style.height = '26px';
        subChev.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none"><path d="M9 6l6 6-6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" opacity=".85"/></svg>';
        subTitle.appendChild(subLeft);
        subTitle.appendChild(subChev);

        const itemList = document.createElement('div');
        itemList.className = 'item-list';

        subTitle.onclick = (e) => {
          e.stopPropagation();
          subgroupEl.classList.toggle('open');
        };

        const items = groups[groupName][subName];
        const itemNames = Object.keys(items).sort((a,b)=>a.localeCompare(b));

        for (const itemName of itemNames){
          const itemData = items[itemName];
          const item = document.createElement('div');
          item.className = 'item';
          item.textContent = itemName;

          item.onclick = () => {
            document.querySelectorAll('.item').forEach(x=>x.classList.remove('active'));
            item.classList.add('active');
            renderCard(itemName, itemData, { group: groupName, sub: subName });
          };

          itemList.appendChild(item);

          itemMeta.push({
            itemEl: item,
            subgroupEl,
            groupEl,
            groupName,
            subName,
            itemNameLower: itemName.toLowerCase(),
            itemData
          });
        }

        subgroupEl.appendChild(subTitle);
        subgroupEl.appendChild(itemList);
        groupContent.appendChild(subgroupEl);
        subMap.set(subName, { subgroupEl, itemList });
      }

      groupEl.appendChild(title);
      groupEl.appendChild(groupContent);
      sidebar.appendChild(groupEl);
      groupMeta.set(groupName, { groupEl, subMap });
    }
  }

  function applySearch(q){
    q = (q || '').trim().toLowerCase();

    // Reset containers visible
    for (const gm of groupMeta.values()){
      gm.groupEl.style.display = 'block';
      for (const sm of gm.subMap.values()){
        sm.subgroupEl.style.display = 'block';
      }
    }

    if (!q){
      for (const it of itemMeta) it.itemEl.style.display = 'block';

      // gentle default open
      for (const gm of groupMeta.values()) gm.groupEl.classList.remove('open');
      for (const it of itemMeta) it.subgroupEl.classList.remove('open');

      const firstGroup = sidebar.querySelector('.group');
      if (firstGroup){
        firstGroup.classList.add('open');
        const firstSub = firstGroup.querySelector('.subgroup');
        if (firstSub) firstSub.classList.add('open');
      }
      return;
    }

    const subHas = new Map(); // group::sub -> bool
    let firstMatchEl = null;

    for (const it of itemMeta){
      const hay = `${it.itemNameLower} ${it.groupName} ${it.subName}`;
      const match = hay.includes(q);
      it.itemEl.style.display = match ? 'block' : 'none';
      if (match){
        subHas.set(`${it.groupName}::${it.subName}`, true);
        if (!firstMatchEl) firstMatchEl = it.itemEl;
      }
    }

    for (const [groupName, gm] of groupMeta.entries()){
      let anyInGroup = false;
      for (const [subName, sm] of gm.subMap.entries()){
        const has = subHas.get(`${groupName}::${subName}`) === true;
        sm.subgroupEl.style.display = has ? 'block' : 'none';
        if (has){
          anyInGroup = true;
          gm.groupEl.classList.add('open');
          sm.subgroupEl.classList.add('open');
        } else {
          sm.subgroupEl.classList.remove('open');
        }
      }
      gm.groupEl.style.display = anyInGroup ? 'block' : 'none';
      if (!anyInGroup) gm.groupEl.classList.remove('open');
    }

    if (firstMatchEl){
      firstMatchEl.scrollIntoView({ block: 'center', behavior: 'smooth' });
    }
  }

  buildUI();

  // gentle default open
  const firstGroup = document.querySelector('#sidebar .group');
  if (firstGroup){
    firstGroup.classList.add('open');
    const firstSub = firstGroup.querySelector('.subgroup');
    if (firstSub) firstSub.classList.add('open');
  }

  search.addEventListener('input', (e)=>applySearch(e.target.value));
}

load();
</script>
</body>
</html>
